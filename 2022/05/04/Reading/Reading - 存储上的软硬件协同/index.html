<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Reading | 存储上的软硬件协同 | Sicilienne</title><meta name="keywords" content="Memory"><meta name="author" content="Zoris"><meta name="copyright" content="Zoris"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Memory">
<meta property="og:type" content="article">
<meta property="og:title" content="Reading | 存储上的软硬件协同">
<meta property="og:url" content="http://example.com/2022/05/04/Reading/Reading%20-%20%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C/index.html">
<meta property="og:site_name" content="Sicilienne">
<meta property="og:description" content="Memory">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png">
<meta property="article:published_time" content="2022-05-04T04:45:12.000Z">
<meta property="article:modified_time" content="2022-05-10T08:08:09.287Z">
<meta property="article:author" content="Zoris">
<meta property="article:tag" content="Memory">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/05/04/Reading/Reading%20-%20%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"简","msgToSimplifiedChinese":"繁"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Reading | 存储上的软硬件协同',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-10 16:08:09'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.githubusercontent.com/Warmchay/img/main/1521647611449_.pic.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">20</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Sicilienne</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 清单</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 照片</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Reading | 存储上的软硬件协同</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-05-04T04:45:12.000Z" title="发表于 2022-05-04 12:45:12">2022-05-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-05-10T08:08:09.287Z" title="更新于 2022-05-10 16:08:09">2022-05-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Reading/">Reading</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Reading | 存储上的软硬件协同"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="存储上的软硬件协同"><a href="#存储上的软硬件协同" class="headerlink" title="存储上的软硬件协同"></a>存储上的软硬件协同</h1><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8A%E5%8D%889.39.28.png" style="zoom:50%;" />

<ul>
<li>CPU 和 Memory 的 gap 越来越大，目前朝着多核发展有所缓和，但还是有很大的 gap</li>
<li>Disk 速度更慢，目前用一些软件方法来解决如操作系统将经常使用的数据存储在主存中，相比访问磁盘提高了访问速度</li>
<li>毫无疑问，主存是目前系统的瓶颈:<ol>
<li>RAM 硬件设计 (速度和并行化)</li>
<li>内存控制做更优的设计</li>
<li>CPU caches</li>
<li>DMA for devices</li>
</ol>
</li>
</ul>
<h1 id="现代硬件-07年-Commodity-Hardware-Today"><a href="#现代硬件-07年-Commodity-Hardware-Today" class="headerlink" title="现代硬件 (07年) - Commodity Hardware Today"></a>现代硬件 (07年) - Commodity Hardware Today</h1><h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><blockquote>
<p>除了 DDR4 还在发展，07 年的硬件和现在没有什么区别</p>
</blockquote>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8A%E5%8D%889.44.53.png" style="zoom:50%;" />

<p>最初的系统分为南北桥，北桥为 CPU 和内存控制器的接口，南桥主要为 I&#x2F;O 的接口。</p>
<p>这种设计会有很多限制:</p>
<ol>
<li>与 RAM 之间的通信都需要通过北桥</li>
<li>CPU 间的通信需要通过北桥上的同一总线</li>
<li>RAM 只有一个接口</li>
</ol>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8A%E5%8D%889.52.18.png" style="zoom:50%;" />

<ul>
<li><p>改进设计: 将北桥与外部内存控制器作分离的设计，这样可以增大带宽</p>
</li>
<li><p>这样的设计瓶颈为北桥带宽</p>
</li>
</ul>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8A%E5%8D%889.53.59.png" style="zoom:50%;" />

<ul>
<li>NUMA - 非一致性内存架构</li>
<li>CPU 相互通信也有一定成本</li>
</ul>
<h2 id="RAM-Types"><a href="#RAM-Types" class="headerlink" title="RAM Types"></a>RAM Types</h2><p>分为 SRAM 和 DRAM，主要在于成本差异，前贵后弱</p>
<h3 id="SRAM"><a href="#SRAM" class="headerlink" title="SRAM"></a>SRAM</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8A%E5%8D%889.57.24.png" style="zoom:50%;" />

<blockquote>
<p>1-bit 的 SRAM 通常由 6 颗晶体管组成成本较高，但是不需要刷新。</p>
</blockquote>
<ul>
<li>WL - 置线</li>
<li>成本较高，但是不需要刷新，可以让数据保持原来的样子</li>
</ul>
<h3 id="DRAM"><a href="#DRAM" class="headerlink" title="DRAM"></a>DRAM</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.17.53.png" style="zoom:50%;" />

<blockquote>
<p>1-bit DRAM由一个电容和一个晶体管组成，成本较低，但是需要刷新</p>
</blockquote>
<ul>
<li>刷新: 因为电容会漏电</li>
<li>For most DRAM chips these days this refresh mush happen every <strong>64ns.</strong></li>
</ul>
<p><strong>电容的充放电特性:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.20.14.png" style="zoom:50%;" />

<blockquote>
<p>R: 电阻 C: 电容容量大小 乘积是某时间单位</p>
</blockquote>
<h3 id="DRAM-Access"><a href="#DRAM-Access" class="headerlink" title="DRAM Access"></a>DRAM Access</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.22.02.png" style="zoom:50%;" />

<ul>
<li>DRAM 以阵列的形式进行排列，每个单元进行 1bit 的存储</li>
<li>左边为 <code>行选通信号</code> ，下边为<code>列选通信号</code>，读取时低电平有效，选中行选中列确定1-bit</li>
<li>设计看起来很简单，但是掀起来还是很复杂的，设计很多细节特别是和电容的特性有关</li>
</ul>
<h2 id="DRAM-Access-Technical-Details"><a href="#DRAM-Access-Technical-Details" class="headerlink" title="DRAM Access Technical Details"></a>DRAM Access Technical Details</h2><h3 id="Read-Access-Protocol"><a href="#Read-Access-Protocol" class="headerlink" title="Read Access Protocol"></a>Read Access Protocol</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.26.16.png" style="zoom:50%;" />

<blockquote>
<p>SDRAM (同步DRAM) 读数据时序图</p>
<p>注意：完整的时序还包括行预充电等过程，参见图2.9</p>
</blockquote>
<ul>
<li>$t_{RCD}:$ Row Addr 和 Col Addr 传入的时间差</li>
<li>$CL:$ 给出 Col Addr 后还需要等待一段时间 $CL$</li>
</ul>
<h3 id="Precharge-and-Activation"><a href="#Precharge-and-Activation" class="headerlink" title="Precharge and Activation"></a>Precharge and Activation</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.31.05.png" style="zoom:50%;" />

<ul>
<li>在读操作前，行选通信号（蓝色部分）已经在做准备，也就是 $t_{RP} \ (Row\ Precharge)$ 这段时间</li>
</ul>
<p><strong>DDR 参数:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.33.49.png" style="zoom:50%;" />



<h3 id="Recharging"><a href="#Recharging" class="headerlink" title="Recharging"></a>Recharging</h3><p>重新充电的时间即为上述提到的 64ns</p>
<h3 id="Memory-Type"><a href="#Memory-Type" class="headerlink" title="Memory Type"></a>Memory Type</h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.37.19.png" style="zoom:50%;" />

<p>从 SDR (Single Date Rate) 到 DDR (Double Data Rate) SDRAMs 的基础 SDRAM </p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.37.25.png" style="zoom:50%;" />

<ul>
<li>频率无变化，通路加倍</li>
</ul>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.37.31.png" style="zoom:50%;" />

<ul>
<li>频率加倍，通路加倍</li>
</ul>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.39.52.png" style="zoom:50%;" />

<ul>
<li>频率继续加倍，通道也继续加倍</li>
</ul>
<p>目前已经发展到了 DDR4。</p>
<h1 id="CPU-Caches"><a href="#CPU-Caches" class="headerlink" title="CPU Caches"></a>CPU Caches</h1><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.46.33.png" style="zoom:40%;" />

<blockquote>
<p>成本越高 速度越快</p>
</blockquote>
<p><strong>04年的数据数量级上的差异:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%882.48.03.png" style="zoom:50%;" />

<ul>
<li>首先，CPU Cache 对用户来说是透明的，也可以说是对编译器</li>
<li>程序和数据的时间局部性和空间局部性：比如同一段代码反复被执行 (循环) 或者访问一块连续的内存空间 （数组）就是空间局部性的例子，频繁访问同一个局部变量就是时间局部性的例子</li>
<li>但是程序员依旧需要帮助处理器去充分利用 Cache</li>
</ul>
<h3 id="CPU-Caches-in-the-Big-Picture"><a href="#CPU-Caches-in-the-Big-Picture" class="headerlink" title="CPU Caches in the Big Picture"></a><strong>CPU Caches in the Big Picture</strong></h3><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.07.16.png" style="zoom:50%;" />

<p>冯诺依曼结构的经验表示尽量采取指令缓存和数据缓存分离的设计，因此之后的 Cache 是将指令和数据分离的</p>
<blockquote>
<p><strong>注意：</strong> 实际上 CPU 流水线设计中的<strong>结构冒险</strong>的一种场景即指令和数据需要同时访问内存，Cache 中指令和数据分离的设计恰好解决了结构冒险这个问题。</p>
</blockquote>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.07.24.png" style="zoom:50%;" />

<ul>
<li>L1 指令和数据缓存分开，L2 和 L3 再放在一起</li>
<li>具体实现由 CPU 设计人员确定，对程序员来说是不可见的</li>
</ul>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.12.18.png" style="zoom:50%;" />

<blockquote>
<p>多核多处理器多线程示意图</p>
</blockquote>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.13.24.png" style="zoom:50%;" />



<h2 id="Cache-Operation-at-High-Level"><a href="#Cache-Operation-at-High-Level" class="headerlink" title="Cache Operation at High Level"></a><strong>Cache Operation at High Level</strong></h2><p>CPU 缓存以“行”形式来存放的，叫做 Cache Line，利用了空间局部性。早期 Cache line 是 32B，现在是 64B。</p>
<blockquote>
<p>也有 128B，如高通 Qualcomm Centriq Falkor，主要用于数据中心作服务器</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.57.20.png" style="zoom:50%;" />

<p><strong>CPU 缓存设计根据不同场景作权衡</strong></p>
</blockquote>
<p><strong>CPU 内部 Cache 的组织方式:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%883.58.22.png" style="zoom:50%;" />

<ul>
<li>Offset 数据偏移量</li>
<li>Cache Set 缓存集</li>
<li>Tag 缓存集里面哪个数据是需要的缓存行 （如 <code>dirty flag</code>）</li>
</ul>
<p>其他的操作:</p>
<ol>
<li><p><strong>缓存一致性</strong></p>
<p>多处理器 &#x2F; 多核上可能存在缓存一致性问题，通过一些协议，如最重要的 <strong>MESI</strong> 来解决</p>
</li>
<li><p><strong>命中率</strong></p>
<p>缓存不命中的可能原因为: 1) 强制性不明中 2) 容量原因不命中 3) 冲突原因不命中。</p>
</li>
<li><p><strong>读取周期</strong> (Pentinum M)</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.09.36.png" style="zoom:50%;" /></li>
</ol>
<p>随机写情况下根据不同的数据量引起的 CPU 操作时间上的差异。</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.09.43.png" style="zoom:50%;" />

<h2 id="CPU-Cache-Implementation-Details"><a href="#CPU-Cache-Implementation-Details" class="headerlink" title="CPU Cache Implementation Details"></a><strong>CPU Cache Implementation Details</strong></h2><h3 id="Associativity-关联度"><a href="#Associativity-关联度" class="headerlink" title="Associativity - 关联度"></a>Associativity - 关联度</h3><ol>
<li><p>Fully Asscociative Cache Schematics - <strong>全关联缓存</strong></p>
<p>相当于缓存集为 1 (没有了 Cache Set)，缓存行可以存放在任意位置，但是硬件实现困难，成本也高。</p>
<p>只适用于“真的非常小”的缓存，如 TLB。</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.09.51.png" style="zoom:50%;" />
</li>
<li><p>Direct-Mapped Cache Schematics - 直接映射缓存</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.10.03.png" style="zoom:50%;" />



<p>Set 选择某一路，Tag 进行比较就可以得到缓存行</p>
</li>
<li><p>Set-Asscociative Cache Scematiccs - 组关联缓存</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.09.57.png" style="zoom:50%;" />

<p>确定在那个 Set 中，在 Set 内进行比较。</p>
<p>大部分情况下都是组关联缓存，L1 常是 8-set(8路) 的。</p>
</li>
</ol>
<p><strong>Cache 的大小和关联性:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%884.35.42.png" style="zoom:50%;" />

<p>缓存越大，miss 的概率越小。</p>
<h3 id="Measurement-of-Cache-Effects"><a href="#Measurement-of-Cache-Effects" class="headerlink" title="Measurement of Cache Effects"></a>Measurement of Cache Effects</h3><blockquote>
<p>这一节主要讲第四章的 TLB，会说明 Cache 的衡量指标。</p>
<p>多用 <code>perf</code></p>
</blockquote>
<h3 id="Write-Behavior"><a href="#Write-Behavior" class="headerlink" title="Write-Behavior"></a>Write-Behavior</h3><p>写行为一般可分为两种: </p>
<ol>
<li>Write-Through 写通</li>
<li>Write-Back 写回</li>
</ol>
<p><strong>Write-Through:</strong> 缓存行一旦被改写，需要立即同步更新主存</p>
<p><strong>Write-Back:</strong> 缓存行一旦被改写，不会立即更新心存，仅作“脏数据”标记。等到改行即将被逐出之前，检查“脏标记”，需要的话再写会主存。</p>
<p><strong>写回策略的显著问题:</strong> 多处理器 &#x2F; 多核的缓存一致性问题 - MESI</p>
<h3 id="Multi-Processor-Support"><a href="#Multi-Processor-Support" class="headerlink" title="Multi-Processor Support"></a>Multi-Processor Support</h3><blockquote>
<p>保持 Cache 一致性的协议常用为 MESI</p>
</blockquote>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.03.29.png" style="zoom:50%;" />

<p>MESI 协议转换图，多在网上找找其他资料熟悉一下</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.10.59.png" style="zoom:50%;" />

<h3 id="Other-Details"><a href="#Other-Details" class="headerlink" title="Other Details"></a>Other Details</h3><p>缓存替换策略常用的即 LRU，或者也可以随机替换(但很少见)。</p>
<h1 id="Virtual-Memory-虚拟内存"><a href="#Virtual-Memory-虚拟内存" class="headerlink" title="Virtual Memory - 虚拟内存"></a>Virtual Memory - 虚拟内存</h1><img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.18.45.png" style="zoom:50%;" />

<p>这部分内容和 OS 密切相关，比如进程管理中 fork 一个进程时的 Copy on Write，缺页时的 Page Fault Handler 等。</p>
<p><strong>为什么需要 VM? Problems?</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.30.04.png" style="zoom:50%;" />

<blockquote>
<p><strong>重点：</strong> program’s mem space to the RAM mem space.</p>
</blockquote>
<p><strong>Virtual Memory is a layer of indirection</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.45.12.png" style="zoom:50%;" />

<blockquote>
<p> 可以把 Disk 中的页载入到存储当中去</p>
</blockquote>
<hr>
<p>谈谈如何解决上述 Cache 中的三个问题:</p>
<ol>
<li><p><strong>#1 not enough memory</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.48.59.png" style="zoom:50%;" />

<p>通过 LRU 将 old data 换出到 Disk 中，new data 换入到 RAM 内，mapping 机制使得内存看起来无穷大:</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.51.28.png" style="zoom:50%;" />

<p>如果内存空间不够，需要经常去读 Disk，Disk 读速度慢于内存的 1000x，所以内存越大速度越快。</p>
</li>
<li><p><strong>#2 holes in the address space</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%885.51.28.png" style="zoom:50%;" />

<p>通过 map 将 program 地址分段映射。</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%8810.30.33.png" style="zoom:50%;" />
</li>
<li><p><strong>#3 keeping programs secure</strong></p>
 <img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-05%20%E4%B8%8B%E5%8D%8810.35.43.png" style="zoom:50%;" />

<p>虚拟内存可以共享段，如右边 <code>save dialog in Mail/Browser</code> 都有相同的部分。</p>
</li>
</ol>
<hr>
<p>虚拟内存由 MMU 实现，虚拟内存管理是系统中最为复杂的部分之一，比如 Slob&#x2F;Slab&#x2F;Slub，还有 Overcommit 以及 OOM 这样的机制，在 Linux 环境下有 <code>/proc/meminfo</code> 描述了虚拟内存的复杂性。</p>
<h2 id="Simplest-Address-Translation"><a href="#Simplest-Address-Translation" class="headerlink" title="Simplest Address Translation"></a>Simplest Address Translation</h2><p>由一级查找即可找到。</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-07%20%E4%B8%8A%E5%8D%889.00.34.png" style="zoom:50%;" />

<p>用索引查找在那一页，后根据 Offset 确定物理地址</p>
<p><strong>完整的页表是存放在主存中的。</strong></p>
<h2 id="Multi-Level-Page-Tables"><a href="#Multi-Level-Page-Tables" class="headerlink" title="Multi-Level Page Tables"></a>Multi-Level Page Tables</h2><p>4KB Pages 一般作为默认值，选择 4K 更多是历史原因，或者说是实践经验值，不去细究。</p>
<p>一级页表需要的存储空间太大，因此采用了多级页表。</p>
<p><strong>page tree walking:</strong></p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-07%20%E4%B8%8A%E5%8D%889.06.09.png" style="zoom:67%;" />

<p>X86-64 为 4KB pages 和 512 entries per directory,内存大小为 $ (2^9)^4 * 2^{12}$</p>
<p>出于安全性考虑，shared libraries 为虚拟地址随机化 (mapped at randomized adddress)</p>
<h2 id="Making-virtual-memory-work"><a href="#Making-virtual-memory-work" class="headerlink" title="Making virtual memory work"></a>Making virtual memory work</h2><p>虚拟内存访问成本较高:</p>
<ul>
<li><p>每个 memory operation 都需要查找 page table</p>
</li>
<li><p>需要访问 (1) <strong>the page table</strong> (2) <strong>the memory address</strong>, 需要耗费 2x 的 memory accesses</p>
<blockquote>
<p>1.33 memory accesses per instruction. This is going to hurt.</p>
</blockquote>
</li>
</ul>
<p>为了让 VM fast，加入特殊的 **Page Table Cache: TLB(Translation Lookaside Buffer)**，根据局部性远离其设计类似于 L1-Cache:</p>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-07%20%E4%B8%8A%E5%8D%889.22.26.png" style="zoom:67%;" />

<p> 让 TLB 变快的方法有:</p>
<ol>
<li><p><strong>Make pages larger</strong></p>
<p>用少量页存储更多的数据</p>
</li>
<li><p><strong>Add a second TLB that is larger, but a bit slower</strong></p>
</li>
<li><p><strong>Have hardware to fill the TLB</strong></p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-07%20%E4%B8%8A%E5%8D%889.30.54.png" style="zoom:50%;" />

<blockquote>
<p>PTE 为 Page Table Entries</p>
</blockquote>
<h3 id="影响-TLB-性能的一些因素"><a href="#影响-TLB-性能的一些因素" class="headerlink" title="影响 TLB 性能的一些因素"></a>影响 TLB 性能的一些因素</h3><ol>
<li>如果页面大，相应的页表项少，那么 TLB 寻址速度也快，但是页面大容易产生很多碎片</li>
<li>如果页面小，碎片相对少，但是页表项多，影响 TLB 寻址速度，因此如何选择是一个折中的方案</li>
<li>实际上，大 page 也逐渐支持使用</li>
</ol>
<img src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-05-07%20%E4%B8%8A%E5%8D%889.37.05.png" style="zoom:67%;" />

<p>可以看到 Cache 和 TLB 的结构设计上逻辑是差不多的。</p>
<h1 id="Memory-Performance-Tools"><a href="#Memory-Performance-Tools" class="headerlink" title="Memory Performance Tools"></a>Memory Performance Tools</h1><p>测试内存性能: brendangregg.com - Linux Performance</p>
<ol>
<li>内存金字塔</li>
<li>熟悉局部性</li>
</ol>
<h1 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h1><ol>
<li><a target="_blank" rel="noopener" href="https://people.freebsd.org/~lstewart/articles/cpumemory.pdf">What Every Programmar Should Know About Memory</a></li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Zoris</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/04/Reading/Reading%20-%20%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C/">http://example.com/2022/05/04/Reading/Reading%20-%20%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Sicilienne</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Memory/">Memory</a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/05/07/Distributed%20System/LevelDB%20%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%20(%E4%B8%80)%20-%20%E5%89%8D%E6%B2%BF%E5%92%8C%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6/"><img class="prev-cover" src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-06%20%E4%B8%8A%E5%8D%889.52.45.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LevelDB 源码分析 (一) ｜ 前沿和基本组件</div></div></a></div><div class="next-post pull-right"><a href="/2022/04/28/Reading/Reading%20-%20CDBTune/"><img class="next-cover" src="https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Reading | CDBTune</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine# Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C"><span class="toc-number">1.</span> <span class="toc-text">存储上的软硬件协同</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">2.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E7%A1%AC%E4%BB%B6-07%E5%B9%B4-Commodity-Hardware-Today"><span class="toc-number">3.</span> <span class="toc-text">现代硬件 (07年) - Commodity Hardware Today</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Intro"><span class="toc-number">3.1.</span> <span class="toc-text">Intro</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RAM-Types"><span class="toc-number">3.2.</span> <span class="toc-text">RAM Types</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SRAM"><span class="toc-number">3.2.1.</span> <span class="toc-text">SRAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DRAM"><span class="toc-number">3.2.2.</span> <span class="toc-text">DRAM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DRAM-Access"><span class="toc-number">3.2.3.</span> <span class="toc-text">DRAM Access</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DRAM-Access-Technical-Details"><span class="toc-number">3.3.</span> <span class="toc-text">DRAM Access Technical Details</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-Access-Protocol"><span class="toc-number">3.3.1.</span> <span class="toc-text">Read Access Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Precharge-and-Activation"><span class="toc-number">3.3.2.</span> <span class="toc-text">Precharge and Activation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recharging"><span class="toc-number">3.3.3.</span> <span class="toc-text">Recharging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory-Type"><span class="toc-number">3.3.4.</span> <span class="toc-text">Memory Type</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CPU-Caches"><span class="toc-number">4.</span> <span class="toc-text">CPU Caches</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU-Caches-in-the-Big-Picture"><span class="toc-number">4.0.1.</span> <span class="toc-text">CPU Caches in the Big Picture</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Cache-Operation-at-High-Level"><span class="toc-number">4.1.</span> <span class="toc-text">Cache Operation at High Level</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU-Cache-Implementation-Details"><span class="toc-number">4.2.</span> <span class="toc-text">CPU Cache Implementation Details</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Associativity-%E5%85%B3%E8%81%94%E5%BA%A6"><span class="toc-number">4.2.1.</span> <span class="toc-text">Associativity - 关联度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Measurement-of-Cache-Effects"><span class="toc-number">4.2.2.</span> <span class="toc-text">Measurement of Cache Effects</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-Behavior"><span class="toc-number">4.2.3.</span> <span class="toc-text">Write-Behavior</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Multi-Processor-Support"><span class="toc-number">4.2.4.</span> <span class="toc-text">Multi-Processor Support</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-Details"><span class="toc-number">4.2.5.</span> <span class="toc-text">Other Details</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Virtual-Memory-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98"><span class="toc-number">5.</span> <span class="toc-text">Virtual Memory - 虚拟内存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Simplest-Address-Translation"><span class="toc-number">5.1.</span> <span class="toc-text">Simplest Address Translation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multi-Level-Page-Tables"><span class="toc-number">5.2.</span> <span class="toc-text">Multi-Level Page Tables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Making-virtual-memory-work"><span class="toc-number">5.3.</span> <span class="toc-text">Making virtual memory work</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BD%B1%E5%93%8D-TLB-%E6%80%A7%E8%83%BD%E7%9A%84%E4%B8%80%E4%BA%9B%E5%9B%A0%E7%B4%A0"><span class="toc-number">5.3.1.</span> <span class="toc-text">影响 TLB 性能的一些因素</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Memory-Performance-Tools"><span class="toc-number">6.</span> <span class="toc-text">Memory Performance Tools</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%95%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">引用</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://raw.githubusercontent.com/Warmchay/img/main/%E6%88%AA%E5%B1%8F2022-04-29%20%E4%B8%8B%E5%8D%8810.47.53.png')"><div id="footer-wrap"><div class="copyright">&copy;2022 By Zoris</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"><script>function loadDisqus () {
  var disqus_config = function () {
    this.page.url = 'http://example.com/2022/05/04/Reading/Reading%20-%20%E5%AD%98%E5%82%A8%E4%B8%8A%E7%9A%84%E8%BD%AF%E7%A1%AC%E4%BB%B6%E5%8D%8F%E5%90%8C/'
    this.page.identifier = '2022/05/04/Reading/Reading - 存储上的软硬件协同/'
    this.page.title = 'Reading | 存储上的软硬件协同'
  };

  window.disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine# Valine' === 'Disqus' || !false) {
  if (false) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><div class="aplayer no-destroy" data-id="7319374102" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>